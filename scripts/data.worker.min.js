import{esclusioni}from"../data/eventi/esclusioni.min.js";import iCalDateParser from"./lib/icsUtils/iCalDateParser.min.js";self.context={},self.context.labels={it:{autori:"Autore",piattaforme:"Ente erogatore",certificati:"Certificato"},en:{autori:"Author",piattaforme:"Learning Platform",certificati:"Certificate"}},self.onmessage=e=>{const t={result:!1};try{e?.data?.action?(t.request=e.data,"renderDataList"===e.data.action?renderDataList(e.data.datasources,e.data.lang).then((e=>{t.html=e,t.result=!0,self.postMessage(t)})).catch((e=>{errorMessage(`onmessage: ${e}`,t)})):(t.html="",errorMessage("onmessage: Invalid action",t))):(t.msg="Missing parameters",self.postMessage(t))}catch(e){errorMessage(`onmessage: ${e}`,t)}};const errorMessage=function(e,t){t.result=!1,t.msg=e,self.postMessage(t)},renderDataList=async function(e,t){return new Promise(((n,a)=>{const r=e.map((e=>fetch(e).then((t=>e.endsWith("ics")?t.text():t.json()))));Promise.allSettled(r).then((e=>{const a=renderExpandables(elaborateData(e),t);n(a)})).catch((e=>{a(e)}))}))},elaborateData=e=>{const t={};return e.forEach((e=>{if(e?.value){const n=eventiSource(e.value);("EventBrite"===n?e.value.orders:"Codemotion"===n?e.value.data.data:"GCalendar"===n?e.value?.VCALENDAR[0]?.VEVENT:e.value).forEach((e=>{const a=parseEvento(e,n);if(a&&!esclusioni.includes(a.id)){const e=a.inizio.getFullYear(),n=t[e]||[];findEvento(a,n)||(n.push(a),t[e]=n)}}))}})),Object.keys(t).forEach((e=>orderListEventiByDateReverse(t[e]))),t},eventiSource=e=>e.VCALENDAR?"GCalendar":e.orders?"EventBrite":e.data?"Codemotion":null,findEvento=(e,t)=>e.id&&t.find((t=>t.id===e.id))||e.ids?.EventBrite&&t.find((t=>t.ids&&t.ids?.EventBrite===e.ids.EventBrite))||e.ids?.Codemotion&&t.find((t=>t.ids&&t.ids?.Codemotion===e.ids.Codemotion))||e.ids?.GCalendar&&t.find((t=>t.ids&&t.ids?.GCalendar===e.ids.GCalendar)),parseEvento=(e,t)=>{let n=null;switch(t){case"EventBrite":n=parseEventoEventBrite(e);break;case"Codemotion":n=parseEventoCodemotion(e);break;case"GCalendar":n=parseEventoGCalendar(e);break;default:n=parseEventoCustom(e)}return n},parseEventoEventBrite=e=>{let t={};try{t.source="EventBrite",t.id=`EventBrite:${e.event.id}`,t.ids=e.event.ids||{EventBrite:e.event.id},t.titolo=clean(e.event.name.text),t.testo=clean(e.event.description.text),t.inizio=new Date(e.event.start.utc),t.fine=new Date(e.event.end.utc),t.link=e.event.vanity_url||e.event.url,e.event.codemotion_id&&(t.ids.Codemotion=e.event.codemotion_id),formatDateRange(t)}catch(e){t=null}return t},parseEventoCodemotion=e=>{let t={};try{t.source="Codemotion",t.piattaforme=[{nome:"Codemotion",link:"https://www.codemotion.com/"}],t.id=`Codemotion:${e.event.uuid}`,t.ids=e.event._ids||{Codemotion:e.event.uuid},t.titolo=clean(e.event.name),t.testo=clean(e.event.description),t.inizio=new Date(e.event.start_datetime),t.fine=new Date(e.event.end_datetime),"online_conference"===e.event.type?t.link=`https://events.codemotion.com/conferences/online/${t.inizio.getFullYear()}/${e.event.slug}`:"webinar"===e.event.type&&(t.link=`https://events.codemotion.com/webinars/${e.event.slug}`),e.event.eventbrite_id&&(t.ids.EventBride=e.event.eventbride_id),formatDateRange(t)}catch(e){t=null}return t},parseEventoGCalendar=e=>{let t={};try{t.source="GCalendar",t.id=`GCalendar:${e.UID||e.UUID}`,t.ids={GCalendar:e.UID||e.UUID},t.titolo=e.SUMMARY?clean(e.SUMMARY):"",t.testo=e.DESCRIPTION?clean(e.DESCRIPTION):"";const n=e.startDate||Object.entries(e).find((([e,t])=>e.startsWith("DTSTART")))?.[1],a=e.endDate||Object.entries(e).find((([e,t])=>e.startsWith("DTEND")))?.[1]||n;t.inizio=n?new Date(iCalDateParser(n)):null,t.fine=a?new Date(iCalDateParser(a)):null,t.link=isValidUrl(e.URL)?e.URL:isValidUrl(e.LOCATION)?e.LOCATION:isValidUrl(e.DESCRIPTION)?e.DESCRIPTION:null,formatDateRange(t)}catch(e){t=null}return t},parseEventoCustom=e=>{const t=e;return t.source="Custom",t.inizio=new Date(e.inizio),t.fine=new Date(e.fine),t},removeHTMLTags=e=>e?e.toString().replace(/(<([^>]+)>)/gi,""):null,isValidUrl=e=>{if(!e)return!1;try{return Boolean(new URL(e))}catch(e){return!1}},clean=e=>{if(!e)return null;const t=e.replace(/(\\r)|(\\n)/g,"&nbsp;").replace(/(\r\n|\n|\r)/gm,"&nbsp;").replace(/\\/g,"").trim();return removeHTMLTags(t)};function formatDateRange(e){e.data=e.inizio.toLocaleDateString("en-GB"),e.fine&&e.fine.toLocaleDateString("en-GB")!==e.data&&(e.fine.getMonth()!==e.inizio.getMonth()?e.data+=`&nbsp;&dash;&nbsp;${e.fine.toLocaleDateString("en-GB")}`:e.data=`${String(e.inizio.getDate()).padStart(2,"0")}&dash;${String(e.fine.getDate()).padStart(2,"0")}/${String(e.inizio.getMonth()+1).padStart(2,"0")}/${e.inizio.getFullYear()}`)}const orderListEventiByDateReverse=e=>{e.sort(((e,t)=>t.inizio-e.inizio))},renderList=function(e,t){return e?.length&&e.length>0?`<ul>${e.reduce(((e,n)=>e+renderRow(n,t)),"")}</ul>`:""},renderExpandable=function(e,t,n,a){const r=((e,t,n)=>`<details data-name="${e}">  \n                  <summary><b>${t}</b></summary>\n                  <div class="content rendered" data-dblist="${e}" lang="${a}">${n}</div>\n                </details>`)(t,n,renderList(e,a));return r},renderExpandables=function(e,t){const n=Object.keys(e);let a="";return n.sort(((e,t)=>t-e)),n.forEach((n=>{a+=renderExpandable(e[n],`eventi_${n}`,n,t)})),a},renderRow=function(e,t){const n=renderTitolo(e,t),a=renderTesto(e,t),r=renderData(e,t),i=renderSezione(e,t,"relatori"),o=renderSezione(e,t,"piattaforme"),s=renderSezione(e,t,"certificati");return`<li data-id="${e.id?e.id:""}" data-online="${e.online?"true":"false"}" data-source="${e.source?e.source:""}">\n      ${n.html}\n      ${a.html}\n      ${r.html}\n      ${i.html}\n      ${o.html}\n      ${s.html}\n</li>`},renderTitolo=function(e,t){return{html:`<h5>\n              ${e.link?`<a href="${e.link}" target="_blank" rel="nofollow noopener noreferrer">${e.titolo}</a>`:e.titolo}\n            </h5>`,text:e.titolo}},renderTesto=function(e,t){return{html:e.testo?`<p class="testo">${e.testo}</p>`:"",text:e.testo?e.testo:""}},renderData=function(e,t){return{html:e.data?`<p class="data">${e.data}</p>`:"",text:e.data?e.data:""}},renderSezione=(e,t,n)=>{if(!e[n])return{html:"",text:""};let a="";const r=e[n].reduce(((e,r)=>{const i=r.nome?r.nome:self.context.labels[t][n];return a+=a?` ${i}`:i,r.link?`${e}, <span><a href="${r.link}" target="_blank" rel="nofollow noopener noreferrer">${i}</a></span>`:`${e}, <span>${i}</span>`}),"");return{html:`<p class="${n}">${r.substring(2)}</p>`,text:a}};